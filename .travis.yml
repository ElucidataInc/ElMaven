sudo: required

matrix:
  include:
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - sourceline: 'deb http://ppa.launchpad.net/beineri/opt-qt591-trusty/ubuntu trusty main'
            - sourceline: 'deb http://in.archive.ubuntu.com/ubuntu/ xenial universe'

      dist: trusty
      language: cpp
      compiler: gcc-5
      group: deprecated-2017Q2
    - os: osx

env:
  - MATRIX_EVAL="CC=gcc-5 && CXX=g++-5"


before_install:
    -  if [ "$TRAVIS_OS_NAME" == "linux" ]; then
            sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0C49F3730359A14518585931BC711F9BA15703C6;
       fi

install:
  - |

    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
        brew install llvm@3.7;
        brew install cppcheck qt;
        brew link qt5 --force;
    fi

    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      sudo apt-get update -qq;
      sudo apt-get install -y -qq  --allow-unauthenticated g++-5 qt59base qt59script qt59declarative libboost-all-dev libnetcdf-dev;
      sudo apt-get -t xenial -qq install lcov
      sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-5 100
      sudo update-alternatives --set gcov /usr/bin/gcov-5
      eval "${MATRIX_EVAL}";
    fi



before_script:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
        source /opt/qt59/bin/qt59-env.sh;
    fi
  - qmake -v

script:
  - |

    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      qmake CONFIG+=debug -o Makefile build.pro;
      make -j4;
      ./run_tests.sh;
    fi

    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      export CXX="g++-5";
      export CC="gcc-5";
      sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-5 /usr/bin/gcc;
      sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-5 /usr/bin/g++;
      g++ -v;
      gcc -v;
      echo no | ./run.sh
      lcov -b src/core/libmaven/ --capture --directory ../build/tmp/maven/ --output-file lcov.info --no-external
      lcov --summary lcov.info
    fi
